<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Личный кабинет</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .role-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .role-admin {
            background-color: #ff9800;
            color: white;
        }
        .role-user {
            background-color: #2196F3;
            color: white;
        }
    </style>
</head>
<body>

<div class="container">

    <h2 class="center">
        Здравствуйте, {{ current_user.username }}!
        {% if current_user.is_admin %}
            <span class="role-badge role-admin">Администратор</span>
        {% else %}
            <span class="role-badge role-user">Пользователь</span>
        {% endif %}
    </h2>

    {% if is_admin %}
        <p class="center role">Вы администратор. Видите все задачи всех пользователей.</p>

        <!-- Блок задач админа (свои задачи) -->
        <div class="card">
            <h3>Ваши задачи</h3>

            <form class="task-form" action="/task/add" method="POST">
                <input type="text" name="title" placeholder="Введите задачу..." required>
                <button type="submit">Добавить</button>
            </form>

            {% if my_tasks %}
                <ul class="task-list">
                    {% for task in my_tasks %}
                        <li class="task-item">
                            {{ task.title }}
                            <a class="delete" href="/task/delete/{{ task.id }}">❌</a>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="empty">Нет задач.</p>
            {% endif %}
        </div>

        <!-- Задачи всех пользователей -->
        <h2 class="center" style="margin-top: 40px;">Управление пользователями</h2>

        <div class="users-grid">
            {% for u in users_with_tasks %}
                {% if u.id != current_user.id %}
                <div class="card user-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h3 style="margin: 0;">
                            {{ u.username }} ({{ u.email }})
                            {% if u.is_admin %}
                                <span class="role-badge role-admin">Админ</span>
                            {% else %}
                                <span class="role-badge role-user">User</span>
                            {% endif %}
                        </h3>
                    </div>

                    <p style="margin: 5px 0; color: #666; font-size: 14px;">
                        Чтобы изменить роль, перейдите в Supabase Table Editor
                    </p>

                    <h4 style="margin-top: 15px;">Задачи:</h4>
                    {% if u.tasks %}
                        <ul class="task-list">
                            {% for task in u.tasks %}
                                <li class="task-item">
                                    {{ task.title }}
                                    <a class="delete" href="/task/delete/{{ task.id }}">❌</a>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="empty">Нет задач.</p>
                    {% endif %}
                </div>
                {% endif %}
            {% endfor %}
        </div>

    {% else %}
        <!-- Обычный пользователь -->
        <p class="center role">Вы обычный пользователь. Видите только свои задачи.</p>

        <div class="card">
            <h2>Ваши задачи</h2>

            <form class="task-form" action="/task/add" method="POST">
                <input type="text" name="title" placeholder="Введите задачу..." required>
                <button type="submit">Добавить</button>
            </form>

            {% if tasks %}
                <ul class="task-list">
                    {% for task in tasks %}
                        <li class="task-item">
                            {{ task.title }}
                            <a class="delete" href="/task/delete/{{ task.id }}">❌</a>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="empty">Нет задач.</p>
            {% endif %}
        </div>
    {% endif %}

    <div class="center" style="margin-top: 20px;">
        <a class="logout-btn" href="/logout">Выйти</a>
    </div>

    <!-- Сообщения flash -->
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div style="margin-top: 20px;">
          {% for msg in messages %}
            <div style="background: #4caf50; color: white; padding: 10px; border-radius: 5px; margin: 5px 0;">
              {{ msg }}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

</div>
</body>
</html>